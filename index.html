<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>デモ_ベアジョン_Q&Aチャット</title>

  <style>
    :root{
      /* 添付ロゴの雰囲気：白＋シアン＋黒 */
      --accent:#00A0D0;
      --accent2:#0bb6ea;

      --bg:#f7fafc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.10);
      --shadow:0 18px 45px rgba(15,23,42,.10);
      --radius:18px;

      --bot:#f1f5f9;
      --user:#00A0D0;
      --userText:#ffffff;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% -10%, rgba(0,160,208,.14), transparent 55%),
        radial-gradient(900px 600px at 85% 0%, rgba(0,160,208,.08), transparent 55%),
        linear-gradient(180deg, #ffffff, var(--bg));
    }

    .wrap{ max-width: 960px; margin: 0 auto; padding: 18px; }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,160,208,.06), rgba(255,255,255,0));
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .logo{
      width: 140px;
      height: auto;
      display:block;
      filter: drop-shadow(0 6px 14px rgba(15,23,42,.10));
    }

    .titleWrap{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    h1{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.02em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .actions{ display:flex; gap:8px; align-items:center; }
    .ghost{
      appearance:none;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
    }
    .ghost:hover{ background: rgba(15,23,42,.03); }

    #log{
      height: 66vh;
      min-height: 380px;
      padding: 16px;
      overflow:auto;
      background:
        linear-gradient(180deg, rgba(241,245,249,.45), rgba(255,255,255,0));
    }

    .msg{ display:flex; margin: 10px 0; gap:8px; }
    .msg.user{ justify-content:flex-end; }
    .bubble{
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid transparent;
      transform: translateY(2px);
      animation: pop .16s ease-out forwards;
    }
    @keyframes pop { to { transform: translateY(0);} }

    .bot .bubble{
      background: var(--bot);
      border-color: rgba(15,23,42,.06);
      border-bottom-left-radius: 6px;
      color: var(--text);
    }
    .user .bubble{
      background: var(--user);
      color: var(--userText);
      border-bottom-right-radius: 6px;
      box-shadow: 0 10px 22px rgba(0,160,208,.22);
    }

    .typing{
      display:inline-flex; gap:6px; align-items:center;
    }
    .typing i{
      width:6px; height:6px; border-radius:999px;
      background: rgba(15,23,42,.45);
      animation: blink 1s infinite ease-in-out;
      display:inline-block;
    }
    .typing i:nth-child(2){ animation-delay:.15s; }
    .typing i:nth-child(3){ animation-delay:.30s; }
    @keyframes blink{
      0%, 80%, 100%{ opacity:.25; transform: translateY(0); }
      40%{ opacity:1; transform: translateY(-2px); }
    }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{
      border: 1px solid rgba(0,160,208,.28);
      background: rgba(0,160,208,.06);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 12px;
      line-height: 1.1;
      font-weight: 800;
    }
    .chip:hover{ background: rgba(0,160,208,.10); }

    footer{
      border-top: 1px solid var(--line);
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      background: #fff;
    }

    .input{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(241,245,249,.75);
      border:1px solid rgba(15,23,42,.10);
      border-radius: 14px;
      padding: 10px 12px;
    }

    input{
      flex:1;
      border:0;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
      padding: 2px 2px;
    }
    input::placeholder{ color: rgba(100,116,139,.85); }

    .send{
      appearance:none;
      border: 1px solid rgba(0,160,208,.25);
      background: linear-gradient(180deg, var(--accent2), var(--accent));
      color: white;
      border-radius: 14px;
      padding: 12px 16px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.02em;
      box-shadow: 0 12px 26px rgba(0,160,208,.22);
    }
    .send:hover{ filter: brightness(1.02); }
    .send:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .ghost:focus-visible, .send:focus-visible, input:focus-visible{
      outline: 3px solid rgba(0,160,208,.25);
      outline-offset: 2px;
      border-radius: 12px;
    }

    @media (max-width: 560px){
      .logo{ width: 110px; }
      #log{ height: 64vh; }
      .bubble{ max-width: 86%; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="brand">
          <!-- logo.png を同じ階層に置くと表示されます（無ければ自動で非表示） -->
          <img class="logo" src="./logo.png" alt="BEAR JOHN" onerror="this.style.display='none'">
          <div class="titleWrap">
            <h1>デモ_ベアジョン_Q&Aチャット</h1>
          </div>
        </div>
        <div class="actions">
          <button class="ghost" id="clear" type="button">会話をクリア</button>
        </div>
      </header>

      <div id="log" aria-live="polite"></div>

      <footer>
        <div class="input">
          <input id="q" type="text" placeholder="質問を入力（例：営業時間は？）" autocomplete="off" />
        </div>
        <button class="send" id="send" type="button">送信</button>
      </footer>
    </div>
  </div>

  <script>
    const QA_JSON_PATH = "./qa.json";

    // 指定の「よくある質問」
    const PRESET_QUESTIONS = [
      "ジャグラーシリーズについて教えて",
      "オススメ機種は？",
      "新台のデータを出して",
      "今週出てない台をランキング形式で出して"
    ];

    let QA = [];
    const logEl = document.getElementById("log");
    const inputEl = document.getElementById("q");
    const sendBtn = document.getElementById("send");

    // タイピング中キャンセル用（会話クリア等で中断できる）
    let typingToken = 0;

    function normalize(s) {
      return (s ?? "")
        .toString()
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "")
        .replace(/　+/g, "")
        .replace(/[?？]+$/g, "")
        .replace(/[。．.、,！!「」『』（）()［］\[\]【】]/g, "");
    }

    function addMessage(role, text) {
      const row = document.createElement("div");
      row.className = "msg " + role;

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text ?? "";

      row.appendChild(bubble);
      logEl.appendChild(row);

      logEl.scrollTop = logEl.scrollHeight;
      return { row, bubble };
    }

    function addTypingDots() {
      const row = document.createElement("div");
      row.className = "msg bot";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      const t = document.createElement("span");
      t.className = "typing";
      t.innerHTML = "<i></i><i></i><i></i>";
      bubble.appendChild(t);
      row.appendChild(bubble);
      logEl.appendChild(row);
      logEl.scrollTop = logEl.scrollHeight;
      return row;
    }

    function makeChips(questions) {
      const box = document.createElement("div");
      box.className = "chips";
      questions.forEach(q => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "chip";
        b.textContent = q;
        b.onclick = () => {
          inputEl.value = q;
          inputEl.focus();
        };
        box.appendChild(b);
      });
      return box;
    }

    function setReady(ready) {
      sendBtn.disabled = !ready;
      inputEl.disabled = !ready;
      inputEl.placeholder = ready ? "質問を入力（例：営業時間は？）" : "Q&Aを読み込み中…";
    }

    function sleep(ms) {
      return new Promise(r => setTimeout(r, ms));
    }

    // 文字単位タイピング（吹き出しクリックでスキップ）
    async function typeText(bubble, fullText, speedMs = 18, tokenAtStart = 0) {
      let skip = false;
      const onClick = () => { skip = true; };
      bubble.addEventListener("click", onClick, { once: true });

      bubble.textContent = "";
      for (let i = 0; i < fullText.length; i++) {
        if (typingToken !== tokenAtStart) return; // 中断
        if (skip) {
          bubble.textContent = fullText;
          break;
        }
        bubble.textContent += fullText[i];
        logEl.scrollTop = logEl.scrollHeight;

        if (fullText[i] === "\n") {
          await sleep(Math.max(6, Math.floor(speedMs / 2)));
        } else {
          await sleep(speedMs);
        }
      }
    }

    async function botTypeMessage(text, extraNode) {
      // 二重送信防止
      setReady(false);

      const token = ++typingToken;
      const { bubble } = addMessage("bot", "");

      await typeText(bubble, text, 18, token);

      if (typingToken !== token) return; // 中断されてたら何もしない

      if (extraNode) bubble.appendChild(extraNode);

      setReady(true);
      inputEl.focus();
    }

    // 検索（完全一致 → 部分一致）
    function findAnswer(userText) {
      const u = normalize(userText);
      if (!u) return { type: "empty" };

      for (const item of QA) {
        if (normalize(item.q) === u) return { type: "exact", item };
      }

      const scored = QA.map(item => {
        const nq = normalize(item.q);
        let score = 0;
        if (nq.includes(u)) score += 2;
        if (u.includes(nq)) score += 1;
        score += Math.max(0, 1 - Math.abs(nq.length - u.length) / 18);
        return { item, score };
      }).filter(x => x.score > 0);

      scored.sort((a,b) => b.score - a.score);

      if (scored.length) {
        return {
          type: "partial",
          item: scored[0].item,
          suggestions: scored.slice(0, 6).map(x => x.item.q)
        };
      }
      return { type: "none" };
    }

    async function loadQA() {
      setReady(false);
      const dots = addTypingDots();

      try {
        const res = await fetch(QA_JSON_PATH, { cache: "no-store" });
        if (!res.ok) throw new Error("fetch failed: " + res.status);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("qa.json is not an array");

        QA = data
          .filter(x => x && typeof x.q === "string" && typeof x.a === "string")
          .map(x => ({ q: x.q.trim(), a: x.a.trim() }));

        dots.remove();

        // 指定どおり：件数は表示しない／挨拶は短く
        await botTypeMessage("こんにちは。質問を入力してください");

        // 指定の「よくある質問」を固定表示
        const chips = makeChips(PRESET_QUESTIONS);
        await botTypeMessage("よくある質問：", chips);

        setReady(true);
        inputEl.focus();

      } catch (e) {
        dots.remove();
        await botTypeMessage(
          "Q&Aの読み込みに失敗しました。\n" +
          "・qa.json が同じ階層にあるか\n" +
          "・JSONの書式（カンマ/括弧）が正しいか\n" +
          "を確認してください。"
        );
        console.error(e);
        setReady(false);
      }
    }

    async function onSend() {
      const text = inputEl.value;
      if (!text || !text.trim() || sendBtn.disabled) return;

      addMessage("user", text);
      inputEl.value = "";

      // “考えてる感”の点々 → 返答をタイピング
      const dots = addTypingDots();
      await sleep(220);
      dots.remove();

      const r = findAnswer(text);

      if (r.type === "exact") {
        await botTypeMessage(r.item.a);
        return;
      }

      if (r.type === "partial") {
        const chips = makeChips(r.suggestions);
        await botTypeMessage(r.item.a + "\n\n（もしかして…）", chips);
        return;
      }

      await botTypeMessage("該当するQ&Aが見つかりませんでした。別の言い方で試してください。");
    }

    sendBtn.addEventListener("click", onSend);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") onSend();
    });

    document.getElementById("clear").addEventListener("click", async () => {
      // タイピングを中断
      typingToken++;
      logEl.innerHTML = "";
      await botTypeMessage("会話をクリアしました。質問を入力してください。");
    });

    loadQA();
  </script>
</body>
</html>
